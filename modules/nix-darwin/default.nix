{ config, lib, ... }:

let
  inherit (lib) types;

  inherit (import ./config/config.nix { inherit lib; }) mkCustomConfig;

  semanticConfType =
    with types;
    let
      confAtom =
        nullOr (oneOf [
          bool
          int
          float
          str
          path
          package
        ])
        // {
          description = "Nix configuration atom (null, Boolean, integer, float, list, derivation, path, attribute set)";
        };
    in
    attrsOf (either confAtom (listOf confAtom));

  # Settings that Determinate Nix handles for you
  disallowedOptions = [
    "always-allow-substitutes"
    "bash-prompt-prefix"
    "external-builders"
    "extra-nix-path"
    "netrc-file"
    "ssl-cert-file"
    "upgrade-nix-store-path-url"
  ];
in
{
  options = {
    determinate-nix = {
      enable = lib.mkOption {
        type = lib.types.bool;
        default = true;
        description = ''
          Whether to enable configuring Determinate Nix via nix-darwin.

          Disabling this stops nix-darwin from managing:

          1. Custom Determinate Nix settings in {file}`/etc/nix/nix.custom.conf`.
          2. Remote Nix builders
          3.


          This allows you to use nix-darwin without it taking over your
          system installation of Nix. Some nix-darwin functionality
          that relies on managing the Nix installation, like the
          `nix.*` options to adjust Nix settings or configure a Linux
          builder, will be unavailable. You will also have to upgrade
          Nix yourself, as nix-darwin will no longer do so.

          ::: {.warning}
          If you have already removed your global system installation
          of Nix, this will break nix-darwin and you will have to
          reinstall Nix to fix it.
          :::
        '';
      };

      settings = lib.mkOption {
        type = types.submodule {
          freeformType = semanticConfType;

          options = { };
        };
        default = { };
      };
    };
  };

  config = mkIf (config.nix.enable) {
    assertions = [
      {
        assertion = lib.all (key: !lib.hasAttr key config.determinate-nix.customSettings) disallowedOptions;
        message = ''
          These settings are not allowed in `nix.settings`:
            ${lib.concatStringsSep ", " disallowedOptions}
        '';
      }
    ];

    environment.etc."nix/nix.custom.conf".text = lib.concatStringsSep "\n" (
      [
        "# This custom configuration file for Determinate Nix is generated by the determinate module for nix-darwin."
        "# Update your custom settings by changing your nix-darwin configuration, not by modifying this file directly."
        ""
      ]
      ++ mkCustomConfig config.determinate-nix.settings
    );
  };
}
